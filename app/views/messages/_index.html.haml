#msg{:style => "padding-bottom:120px;position:relative"}
  /=debug session.to_a
  /=debug session["1_#{current_user}"]
  /=debug current_user.email + params[:room_id]
  = will_paginate(@msgs, :renderer => "MyLinkRenderer", :page_links =>false)
  - msgs.reverse.each do |msg|
    .piece
      %a.signature= msg.user.username      
      - if msg.user.username == "#{current_user.username}"
        .messages.mine{:id => "#{msg.id}" }
          = raw blacklist markdown(msg.body)
          .holder
            %a{:href => "/vote/#{msg.id}", "data-remote" => "true"} 赞
            %a{:href => "#", :class => "rt", :id => "#{msg.user.username}"} 回
      - else
        .messages{:id => "#{msg.id}" }
          = raw blacklist markdown(msg.body)
          .holder
            %a{:href => "#"} 赞  
            %a{:href => "#", :class => "rt", :id => "#{msg.user.username}"} 回
#input-area{:style => "background-color:#E0E0E0;position:fixed;bottom:0;left:0;width: 100%;height: 100px;"}
  %table
    %tr
      %td{:style => "width:10%;"}

      %td
        = form_for Message.new, :remote => true, :html => {:class => "form-horizontal"} do |f|
          = hidden_field_tag(:room_id, room.id)
          = f.text_area :body, {:class => "span2", :cols => 40, :rows => 5, :style => "width:520px;"}
      %td
        #notifications
          没有人回复你哦

:javascript  
  var online_users = #{@users_online}

  console.log("Online_Users:" + online_users);
  var jug = new Juggernaut(function(){console.log("initialize done")});
  //$("#msg").height( $("#msg").height() + $("#msg .piece:last-child .messages").height() - 500);    
  $("html body").animate({scrollTop: "999999px"}, 100);  
  jug.subscribe("#{@room.id}", function(data){
    console.log("Got data: " +data["username"] + "|" + data["msg"] + "#{current_user.username}" + "online:" + data["online"]);
    var online_users = data["online"];
    var flag = false;
    console.log(data["msg_id"] + "|" + data["notify_users"]);
    //$("#notifications").html("<div>" + data["notify_users"] + "</div>");
    for( i in data["notify_users"] )
    {
      if ("#{current_user.id}" == data["notify_users"][i])   
      {
        var flag = true;
      } 
    }
    if(data["username"]=="#{current_user.username}")
    {
      $("#msg").append("<div class='piece'>" + "<a href='#' class='signature'>"+ data["username"] + "</a>" + "<div class='messages mine' id=" + data["msg_id"] + ">" + data["msg"] + "<div class='holder'>" +
      "<a href='/vote/" + data["msg_id"] + "' data-remote='true'>赞</a>" +
      "<a href='#'' class='rt' id=" + data["username"] + ">回</a></div>" +"</div>" + "</div>");    
    }
    else if(flag == true)
    {                     
      $("#msg").append("<div class='piece'>" + "<a href='#' class='signature'>"+ data["username"] + "</a>" + "<div class='messages mentioned'"+ data["msg_id"] + ">" + data["msg"] + "<div class='holder'>" +
      "<a href='/vote/" + data["msg_id"]+ "' data-remote='true'>赞</a>" +
      "<a href='#'' class='rt' id=" + data["username"] + ">回</a></div>" +"</div>" + "</div>");     
    }
    else
    {
      $("#msg").append("<div class='piece'>" + "<a href='#' class='signature'>"+ data["username"] + "</a>" + "<div class='messages'"+ data["msg_id"] + ">" + data["msg"] + "<div class='holder'>" +
      "<a href='/vote/" + data["msg_id"]+ "' data-remote='true'>赞</a>" +
      "<a href='#'' class='rt' id=" + data["username"] + ">回</a></div>" +"</div>" + "</div>");
    }
    //$("#msg").height( $("#msg").height() + $("#msg .piece:last-child .messages").height());
    $("html body").animate({scrollTop: "999999px"}, 100);    
    if(data["username"].indexOf(String("#{current_user.username}")) >= 0){
      $('#message_body').val('');
      }
  }); 

  $("textarea").atWho("@",{'debug':true,'data':online_users} );  

  $("#message_body").keypress(function(e)    
  {    
    if(e.which == 13 && !e.shiftKey)
    {
      $("form").submit();
    }
  });  

  $(".messages").live("hover",function(){     
    id = $(this).attr("id");    
    new_filter = "#"+ id + " .holder"     
    $(new_filter).show();
  }).mouseleave(function(){
    $(".holder").hide();
  });

  $(".rt").live("click",function(data){
    id = $(this).attr("id")
    var content = $("textarea").val();
    content += " " + "@"+id;
    $("textarea").val(content);
  })
  $(window).unload(function(e) {       
    $.get("/leave/#{@room.id}",{room_id:#{@room.id}} );
    //alert('aa');    
  });
    

:css
  .piece
  {
    clear: both;
    margin-bottom: 3px;
    padding-top: 5px;
    min-width: 400px;
    height:auto;
  }
  .signature
  {
    width: 5%;
    float: left;
    margin: 0px 1% 0px 0px;
    text-align: right;
    word-wrap: break-word;
    padding-top: 5px;    
  }
  .messages
  {
    background-color: #F6F6F6;
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
    border-radius: 6px;
    padding: 5px 5px 5px 5px;
    float: left;
    word-wrap: break-word;
    width: 91%;
    color: #222;        
    position:relative;
  }
  .messages p
  {
    margin:0;
    width:95%;    
  }
  .mine
  {
    background-color: #FBF2D9;
  }
  .mentioned
  {
    background-color: #FFFF00; 
  }
  .messages .holder
  {        
    position:absolute;
    right:0;
    top:5px;
    z-index: 1;
    width:40px;    
    height:25px;
    display:none;
  }
  .messages .holder a
  {
    color:#333;
  }